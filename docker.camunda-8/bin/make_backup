#!/bin/bash
# Script to create a backup of Camunda 8 data

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
CAMUNDA_DIR="$(dirname "$SCRIPT_DIR")"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="$CAMUNDA_DIR/backup/camunda_backup_$DATE"

# Create backup directory
mkdir -p "$BACKUP_DIR"

echo "Starting Camunda 8 backup..."

# Stop services
cd "$CAMUNDA_DIR"
docker-compose down

# Backup postgres data
echo "Backing up PostgreSQL data..."
tar -czf "$BACKUP_DIR/postgres_data.tar.gz" -C "$CAMUNDA_DIR/container.postgres" data

# Backup web-modeler-db data
echo "Backing up Web Modeler DB data..."
tar -czf "$BACKUP_DIR/web_modeler_db_data.tar.gz" -C "$CAMUNDA_DIR/container.web-modeler-db" data

# Backup elasticsearch data
echo "Backing up Elasticsearch data..."
tar -czf "$BACKUP_DIR/elasticsearch_data.tar.gz" -C "$CAMUNDA_DIR/container.elasticsearch" data

# Backup zeebe data
echo "Backing up Zeebe data..."
tar -czf "$BACKUP_DIR/zeebe_data.tar.gz" -C "$CAMUNDA_DIR/container.zeebe" data

# Backup keycloak data
echo "Backing up Keycloak data..."
tar -czf "$BACKUP_DIR/keycloak_data.tar.gz" -C "$CAMUNDA_DIR/container.keycloak" data

# Backup web modeler components
echo "Backing up Web Modeler components..."
tar -czf "$BACKUP_DIR/web_modeler_restapi_data.tar.gz" -C "$CAMUNDA_DIR/container.web-modeler-restapi" data
tar -czf "$BACKUP_DIR/web_modeler_webapp_data.tar.gz" -C "$CAMUNDA_DIR/container.web-modeler-webapp" data
tar -czf "$BACKUP_DIR/web_modeler_websockets_data.tar.gz" -C "$CAMUNDA_DIR/container.web-modeler-websockets" data

# Backup configuration files
echo "Backing up configuration files..."
tar -czf "$BACKUP_DIR/configuration.tar.gz" -C "$CAMUNDA_DIR" configuration

# Create backup metadata
echo "Creating backup metadata..."
cat > "$BACKUP_DIR/metadata.txt" << EOL
Camunda 8 Backup
Date: $(date)
Backup components:
- PostgreSQL data
- Web Modeler DB data
- Elasticsearch data
- Zeebe data
- Keycloak data
- Web Modeler components
- Configuration files
EOL

echo "Backup complete. Stored in $BACKUP_DIR"

# Restart services
docker-compose up -d

echo "Services restarted." 